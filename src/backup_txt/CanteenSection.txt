import React, { useState, useEffect } from 'react';
import {
  Box,
  Container,
  Typography,
  Card,
  CardContent,
  Grid,
  TextField,
  Button,
  IconButton,
  InputBase,
  Paper,
  Divider,
  CircularProgress,
  Alert,
  useTheme,
  alpha,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Fab,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Chip,
  Tabs,
  Tab,
  Rating,
  Badge,
  Menu,
  MenuItem
} from '@mui/material';
import {
  Search as SearchIcon,
  Add as AddIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Restaurant as RestaurantIcon,
  AttachMoney as AttachMoneyIcon,
  Timer as TimerIcon,
  Notifications as NotificationsIcon,
  Star as StarIcon,
  StarBorder as StarBorderIcon,
  RateReview as RateReviewIcon
} from '@mui/icons-material';
import StudentCanteenView from './StudentCanteenView';

const CanteenSection = ({user}) => {
  const theme = useTheme();
  const [menu, setMenu] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  //const [userRole, setUserRole] = useState('authority');
  const [openDialog, setOpenDialog] = useState(false);
  const [selectedItem, setSelectedItem] = useState(null);
  const [activeTab, setActiveTab] = useState(0);
  const [newItem, setNewItem] = useState({
    name: '',
    description: '',
    price: '',
    category: '',
    available: true,
    preparationTime: ''
  });
  const userRole = user?.role || 'student';
  useEffect(() => {
    fetchMenu();
  }, []);

  const fetchMenu = async () => {
  try {
    const response = await fetch("http://localhost:5000/api/authority/canteen-menu");
    const data = await response.json();
    
    // Convert rating to number and ensure it exists; ensure reviews is an array
    const formattedData = data.map(item => ({
      ...item,
      rating: item.rating ? parseFloat(item.rating) : 0,
      price: item.price !== undefined && item.price !== null ? parseFloat(item.price) : 0,
      reviews: Array.isArray(item.reviews) ? item.reviews : []
    }));
    
    setMenu(formattedData);
  } catch (err) {
    setError('Failed to fetch menu');
  } finally {
    setLoading(false);
  }
};


  const handleAddItem = async () => {
  if (!newItem.name || !newItem.price || !newItem.category) return;

  try {
    const response = await fetch("http://localhost:5000/api/authority/canteen-menu", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ...newItem,
        price: parseFloat(newItem.price),
        created_by: 1
      })
    });
    const newItemData = await response.json();
    
    // Ensure rating is a number
    const formattedItem = {
      ...newItemData,
      rating: newItemData.rating ? parseFloat(newItemData.rating) : 0,
      price: parseFloat(newItemData.price)
    };
    
    setMenu([formattedItem, ...menu]);
    handleCloseDialog();
  } catch (err) {
    setError('Failed to add item');
  }
};

  const handleEditItem = (item) => {
  setSelectedItem(item);
  setNewItem({
    name: item.name,
    description: item.description,
    price: item.price.toString(),
    category: item.category,
    available: item.available,
    preparationTime: item.preparation_time
  });
  setOpenDialog(true);
};

  const handleDeleteItem = async (item) => {
  try {
    await fetch(`http://localhost:5000/api/authority/canteen-menu/${item.item_id}`, {
      method: "DELETE"
    });
    setMenu(menu.filter(m => m.item_id !== item.item_id));
  } catch (err) {
    setError('Failed to delete item');
  }
};

  const handleCloseDialog = () => {
    setOpenDialog(false);
    setSelectedItem(null);
    setNewItem({
      name: '',
      description: '',
      price: '',
      category: '',
      available: true,
      preparationTime: ''
    });
  };

  const handleToggleAvailability = async (item) => {
  try {
    const response = await fetch(
      `http://localhost:5000/api/authority/canteen-menu/${item.item_id}/availability`,
      {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ available: !item.available })
      }
    );
    const updatedItem = await response.json();
    setMenu(menu.map(m => m.item_id === updatedItem.item_id ? updatedItem : m));
  } catch (err) {
    setError('Failed to update availability');
  }
};

  const filteredMenu = menu.filter(item =>
    item.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    item.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
    item.category.toLowerCase().includes(searchQuery.toLowerCase())
  );

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh' }}>
        <CircularProgress />
      </Box>
    );
  }

  if (error) {
    return (
      <Container maxWidth="lg" sx={{ py: 4 }}>
        <Alert severity="error">{error}</Alert>
      </Container>
    );
  }

  return (
  <>
    {userRole === 'authority' ? (
      /* ===========================
         üßë‚Äçüíº AUTHORITY INTERFACE
      ============================ */
      <Box sx={{ display: 'flex', minHeight: '100vh', bgcolor: '#f8fafc' }}>
        <Container maxWidth="lg" sx={{ py: 4 }}>
          {/* Header */}
          <Box
            sx={{
              bgcolor: 'primary.main',
              color: 'white',
              p: 4,
              borderRadius: 2,
              mb: 4,
              position: 'relative'
            }}
          >
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <Box>
                <Typography variant="h4" gutterBottom>
                  Canteen Menu
                </Typography>
                <Typography variant="body1" sx={{ opacity: 0.9 }}>
                  Manage today's menu
                </Typography>
              </Box>
              <Fab
                color="secondary"
                aria-label="add"
                onClick={() => setOpenDialog(true)}
                size="medium"
              >
                <AddIcon />
              </Fab>
            </Box>
          </Box>

          {/* Search Bar */}
          <Paper
            sx={{
              p: '2px 4px',
              display: 'flex',
              alignItems: 'center',
              mb: 4,
              bgcolor: alpha(theme.palette.primary.main, 0.05),
            }}
          >
            <IconButton sx={{ p: '10px' }}>
              <SearchIcon />
            </IconButton>
            <InputBase
              sx={{ ml: 1, flex: 1 }}
              placeholder="Search menu items..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
          </Paper>

          {/* Menu List */}
          <List>
            {filteredMenu.map((item) => (
              <Card
                key={item.item_id}
                sx={{
                  mb: 2,
                  transition: 'transform 0.2s, box-shadow 0.2s',
                  '&:hover': {
                    transform: 'translateY(-4px)',
                    boxShadow: theme.shadows[4],
                  },
                  opacity: item.available ? 1 : 0.7
                }}
              >
                <CardContent>
                  <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                    <Box>
                      <Typography variant="h6" gutterBottom>
                        {item.name}
                      </Typography>
                      <Typography variant="body2" color="text.secondary" paragraph>
                        {item.description}
                      </Typography>
                      <Box sx={{ display: 'flex', gap: 1, mb: 1 }}>
                        <Chip icon={<AttachMoneyIcon />} label={`‚Çπ${item.price}`} color="primary" size="small" />
                        <Chip icon={<TimerIcon />} label={item.preparationTime} color="info" size="small" />
                        <Chip label={item.category} color="secondary" size="small" />
                        <Chip icon={<StarIcon />} label={item.rating.toFixed(1)} color="warning" size="small" />
                        {!item.available && (
                          <Chip label="Not Available" color="error" size="small" />
                        )}
                      </Box>
                    </Box>
                    <Box sx={{ display: 'flex', gap: 1 }}>
                      <Button
                        size="small"
                        variant="outlined"
                        startIcon={<EditIcon />}
                        onClick={() => handleEditItem(item)}
                      >
                        Edit
                      </Button>
                      <Button
                        size="small"
                        variant="outlined"
                        color="error"
                        startIcon={<DeleteIcon />}
                        onClick={() => handleDeleteItem(item)}
                      >
                        Delete
                      </Button>
                      <Button
                        size="small"
                        variant={item.available ? "outlined" : "contained"}
                        color={item.available ? "error" : "success"}
                        onClick={() => handleToggleAvailability(item)}
                      >
                        {item.available ? "Mark Unavailable" : "Mark Available"}
                      </Button>
                    </Box>
                  </Box>
                </CardContent>
              </Card>
            ))}
          </List>

          {/* Add/Edit Dialog */}
          <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth="sm" fullWidth>
            <DialogTitle>{selectedItem ? 'Edit Menu Item' : 'Add New Menu Item'}</DialogTitle>
            <DialogContent>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, pt: 2 }}>
                <TextField label="Item Name" fullWidth value={newItem.name}
                  onChange={(e) => setNewItem({ ...newItem, name: e.target.value })} />
                <TextField label="Description" fullWidth multiline rows={2} value={newItem.description}
                  onChange={(e) => setNewItem({ ...newItem, description: e.target.value })} />
                <TextField label="Price (‚Çπ)" fullWidth type="number" value={newItem.price}
                  onChange={(e) => setNewItem({ ...newItem, price: e.target.value })} />
                <TextField label="Category" fullWidth value={newItem.category}
                  onChange={(e) => setNewItem({ ...newItem, category: e.target.value })} />
                <TextField label="Preparation Time" fullWidth value={newItem.preparationTime}
                  onChange={(e) => setNewItem({ ...newItem, preparationTime: e.target.value })}
                  placeholder="e.g., 15-20 mins" />
              </Box>
            </DialogContent>
            <DialogActions>
              <Button onClick={handleCloseDialog}>Cancel</Button>
              <Button
                onClick={handleAddItem}
                variant="contained"
                disabled={!newItem.name || !newItem.price || !newItem.category}
              >
                {selectedItem ? 'Save Changes' : 'Add Item'}
              </Button>
            </DialogActions>
          </Dialog>
        </Container>
      </Box>
    ) : (
      /* ===========================
         üéì STUDENT INTERFACE
      ============================ */
      <StudentCanteenView user={user} />
    )}
  </>
);

};

export default CanteenSection; 